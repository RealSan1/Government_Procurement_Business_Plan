name: E2E Selenium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * *'

jobs:
  e2e-test:
    runs-on: ubuntu-latest
    
    services:
      # MySQL 서비스 (선택사항 - 통합 테스트용)
      # mysql:
      #   image: mysql:8.0
      #   env:
      #     MYSQL_ROOT_PASSWORD: root
      #     MYSQL_DATABASE: test_db
      #   options: >-
      #     --health-cmd="mysqladmin ping"
      #     --health-interval=10s
      #     --health-timeout=5s
      #     --health-retries=3
      #   ports:
      #     - 3306:3306

    steps:
      - uses: actions/checkout@v3

      - name: Set up Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-timeout
          pip install -r requirements.txt

      - name: Install Chrome and Chromium (for Selenium)
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser chromium-chromedriver

      - name: Start FastAPI server
        run: |
          python -m uvicorn main:app --host 127.0.0.1 --port 8000 &
          sleep 3
        env:
          DATABASE_URL: sqlite:///test.db

      - name: Run E2E tests with Selenium
        env:
          BASE_URL: https://port-0-government-procurement-business-plan-mgjckxvm97f5b4e4.sel3.cloudtype.app/
        run: |
          pytest tests/test_e2e_selenium.py -v --tb=short --timeout=60

      - name: Upload Selenium screenshots (on failure)
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: selenium-screenshots
          path: tests/_last_run/
          retention-days: 7

      - name: Generate E2E test report
        if: always()
        run: |
          pytest tests/test_e2e_selenium.py --html=e2e-report.html --self-contained-html || true

      - name: Upload E2E report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-report
          path: e2e-report.html
          retention-days: 7
